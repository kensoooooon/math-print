{% extends 'math_print/base.html' %}

{% block script %}
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {
            inlineMath: [["$","$"],["\\(","\\)"]],
            displayMath: [["$$","$$"],["\\[","\\]"]]
        }
        });
</script>

<script>
function showAnswer(){
    var nodes = document.getElementsByClassName('answer');
    for(var i = 0; i < nodes.length; i++){
        nodes[i].style.visibility = 'visible';
    }
}
function refresh() {
    var url = location.origin;
    var pathname = location.pathname;
    var hash = location.hash;

  location = url + pathname + '?application_refresh=' + (Math.random() * 100000) + hash;
}
</script>

<script>
    function showAnswer(){
        var nodes = document.getElementsByClassName('answer');
        for(var i = 0; i < nodes.length; i++){
        nodes[i].style.visibility = 'visible';
    }
    
    }
    function refresh() {
        var url = location.origin;
        var pathname = location.pathname;
        var hash = location.hash;
        location = url + pathname + '?application_refresh=' + (Math.random() * 100000) + hash;
    }
</script>
    
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>

<script>
    window.addEventListener("load", draw);

    function drawClock(stage, hour, minute) {
        // w=640, h=320
        // 時計のベースとなる円の描画
        const circle = new createjs.Shape();
        circle.graphics.setStrokeStyle(3).beginStroke("black").drawCircle(320, 160, 160);  // 中心(320, 160), 半径160
        stage.addChild(circle);
    
        // 時計の文字盤に1~12の数字を表示
        const radius = 140;  // 数字を配置する円の半径（時計より少し内側）
        for (let i = 1; i <= 12; i++) {
            const angle = (i - 3) * (Math.PI * 2) / 12;  // 時計の角度を計算（0時は上ではなく右なので-3）
            const x = 320 + radius * Math.cos(angle);    // 中心のx座標
            const y = 160 + radius * Math.sin(angle);    // 中心のy座標
            const text = new createjs.Text(i.toString(), "20px Arial", "black");
            text.textAlign = "center";
            text.textBaseline = "middle";
            text.x = x;
            text.y = y;
            stage.addChild(text);
        }
    
        // 分の刻み線を描画
        const tickRadius = 160;  // 刻みの位置
        const tickLength = 10;   // 刻み線の長さ
        for (let i = 0; i < 60; i++) {
            const angle = (i - 15) * (Math.PI * 2) / 60;  // 60分の角度を計算
            const startX = 320 + tickRadius * Math.cos(angle);
            const startY = 160 + tickRadius * Math.sin(angle);
            const endX = 320 + (tickRadius - tickLength) * Math.cos(angle);
            const endY = 160 + (tickRadius - tickLength) * Math.sin(angle);
    
            const tick = new createjs.Shape();
            tick.graphics.setStrokeStyle(i % 5 === 0 ? 3 : 1).beginStroke("black")
                .moveTo(startX, startY).lineTo(endX, endY);
            stage.addChild(tick);
        }
    
        // 短針の描画（hour, minuteをもとに角度計算）
        const shortHandLength = 80;
        const hourAngle = ((hour % 12) + minute / 60) * (Math.PI * 2) / 12 - Math.PI / 2;  // 時針の角度
        const shortHandX = 320 + shortHandLength * Math.cos(hourAngle);
        const shortHandY = 160 + shortHandLength * Math.sin(hourAngle);
    
        const shortHand = new createjs.Shape();
        shortHand.graphics.setStrokeStyle(6).beginStroke("black")
            .moveTo(320, 160).lineTo(shortHandX, shortHandY);  // 中心から短針の先まで
        stage.addChild(shortHand);
    
        // 長針の描画（minuteをもとに角度計算）
        const longHandLength = 120;
        const minuteAngle = (minute * (Math.PI * 2) / 60) - Math.PI / 2;  // 分針の角度
        const longHandX = 320 + longHandLength * Math.cos(minuteAngle);
        const longHandY = 160 + longHandLength * Math.sin(minuteAngle);
    
        const longHand = new createjs.Shape();
        longHand.graphics.setStrokeStyle(4).beginStroke("black")
            .moveTo(320, 160).lineTo(longHandX, longHandY);  // 中心から長針の先まで
        stage.addChild(longHand);
    
        // ステージを更新して描画
        stage.update();
    }
    
    function draw() {
        let hour;
        let minute;
        {% for math_problem_tuple in math_problem_tuple_list %}
            {% if math_problem_tuple.0.show_canvas %}
                // 左側の問題に対してキャンバスを描画
                const left_stage_{{ forloop.counter }} = new createjs.Stage("left_canvas_{{ forloop.counter }}");
                hour = {{ math_problem_tuple.0.time_information.hour }};  // 修正済み
                minute = {{ math_problem_tuple.0.time_information.minute }};  // 修正済み
                drawClock(left_stage_{{ forloop.counter }}, hour, minute);

            {% endif %}
            
            {% if math_problem_tuple.1.show_canvas %}
                // 右側の問題に対してキャンバスを描画
                const right_stage_{{ forloop.counter }} = new createjs.Stage("right_canvas_{{ forloop.counter }}");
                hour = {{ math_problem_tuple.1.time_information.hour }};  // 修正済み
                minute = {{ math_problem_tuple.1.time_information.minute }};  // 修正済み
                drawClock(right_stage_{{ forloop.counter }}, hour, minute);
            {% endif %}
        {% endfor %}
    }
    

</script>
{% endblock %}

{% block css %}
{% endblock %}

{% block title %}
時計
{% endblock %}

{% block hero_unit %}
<div class="p-3 p-sm-5 mb-4 bg-img hero_unit">
    <div class="container">
        <h1 class="display-4">ようこそ!</h1>
        <p class="text-dark">時計</p>
    </div>
</div>
{% endblock %}

{% block body %}

<ol>
    {% for math_problem_tuple in math_problem_tuple_list %}
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <li>
                        <p>
                            {% if math_problem_tuple.0.show_canvas %}
                                \( \quad \)
                                <canvas id="left_canvas_{{ forloop.counter }}" width="640" height="320"></canvas>
                            {% endif %}
                            <br>
                            {{ math_problem_tuple.0.problem | linebreaksbr }}
                        </p>
                        <p class="answer" style="visibility:hidden;">
                            {{ math_problem_tuple.0.answer | linebreaksbr }}
                        </p>
                    </li>
                </div>
                <div class="col-md-6">
                    <li>
                        <p>
                            {% if math_problem_tuple.1.show_canvas %}
                                \( \quad \)
                                <canvas id="right_canvas_{{ forloop.counter }}" width="640" height="320"></canvas>
                            {% endif %}
                            <br>
                            {{ math_problem_tuple.1.problem | linebreaksbr }}
                        </p>
                        <p class="answer" style="visibility:hidden;">
                            {{ math_problem_tuple.1.answer | linebreaksbr }}
                        </p>
                    </li>
                </div>
            </div>
        </div>
    {% endfor %}
</ol>

<div class="d-grid gap-3 col-6 mx-auto">
    <button class="btn btn-outline-success" type="button" onclick="showAnswer()">答えを表示する</button>
    <button class="btn btn-outline-success" type="button" onclick="location.reload(false)">もう一度解く</button>
    <a href="{% url 'elementary_school2' %}" class="btn btn-primary" type="button">問題選択へ戻る</a>
    <a href="{% url 'index' %}" class="btn btn-primary" type="button">トップへ戻る</a>
</div>

<footer class="container-fluid print_footer">
    <small><a href="#">© 2024 有明学習振興</a></small>
</footer>
{% endblock %}